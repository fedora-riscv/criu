From e4cc6dda5da18153a5ecfb969d9aa4d64ba05a4c Mon Sep 17 00:00:00 2001
From: Alexander Mikhalitsyn <alexander.mikhalitsyn@virtuozzo.com>
Date: Tue, 21 Dec 2021 18:27:52 +0300
Subject: [PATCH 236/245] kerndat: check for rseq syscall support

Signed-off-by: Alexander Mikhalitsyn <alexander.mikhalitsyn@virtuozzo.com>
---
 criu/include/kerndat.h |  1 +
 criu/kerndat.c         | 18 ++++++++++++++++++
 2 files changed, 19 insertions(+)

diff --git a/criu/include/kerndat.h b/criu/include/kerndat.h
index de14028f5..986dcdc09 100644
--- a/criu/include/kerndat.h
+++ b/criu/include/kerndat.h
@@ -80,6 +80,7 @@ struct kerndat_s {
 	dev_t hugetlb_dev[HUGETLB_MAX];
 	bool has_move_mount_set_group;
 	bool has_openat2;
+	bool has_rseq;
 };
 
 extern struct kerndat_s kdat;
diff --git a/criu/kerndat.c b/criu/kerndat.c
index 93617012a..05cc5293b 100644
--- a/criu/kerndat.c
+++ b/criu/kerndat.c
@@ -905,6 +905,20 @@ static int kerndat_x86_has_ptrace_fpu_xsave_bug(void)
 	return 0;
 }
 
+static int kerndat_has_rseq(void)
+{
+	if (syscall(__NR_rseq, NULL, 0, 0, 0) != -1) {
+		pr_err("rseq should fail\n");
+		return -1;
+	}
+	if (errno == ENOSYS)
+		pr_info("rseq syscall isn't supported\n");
+	else
+		kdat.has_rseq = true;
+
+	return 0;
+}
+
 int kerndat_sockopt_buf_lock(void)
 {
 	int exit_code = -1;
@@ -1606,6 +1620,10 @@ int kerndat_init(void)
 		pr_err("kerndat_has_openat2 failed when initializing kerndat.\n");
 		ret = -1;
 	}
+	if (!ret && kerndat_has_rseq()) {
+		pr_err("kerndat_has_rseq failed when initializing kerndat.\n");
+		ret = -1;
+	}
 
 	kerndat_lsm();
 	kerndat_mmap_min_addr();
-- 
2.35.1

